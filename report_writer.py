#!/usr/bin/env python
# coding: utf-8

# In[ ]:


import streamlit as st
from openai import OpenAI

# ğŸ”‘ OpenAI í‚¤ ì„¤ì •
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

# âœ… ìœ í˜•ë³„ ì§€ì‹œë¬¸
def get_prompt_by_report_type(report_type):
    if report_type == "ê³„íšë³´ê³ ":
        return "ê³„íšë³´ê³ ëŠ” í–¥í›„ ì¶”ì§„ë°©í–¥, ì¼ì •, ì˜ˆì‚°, ê¸°ëŒ€íš¨ê³¼ ë“±ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•  ê²ƒ. ì¶”ì§„ë°°ê²½ê³¼ ëª©ì ë„ ê°„ê²°íˆ í¬í•¨í•˜ë˜, ì „ì²´ì ìœ¼ë¡œ ë¯¸ë˜ì§€í–¥ì ì´ê³  ì „ëµì ì¸ ë¬¸ì¥ì„ ì‚¬ìš©í•  ê²ƒ."
    elif report_type == "ë™í–¥ë³´ê³ ":
        return "ë™í–¥ë³´ê³ ëŠ” ìµœê·¼ ë³€í™”ë‚˜ í˜„í™©ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•  ê²ƒ. í†µê³„ë‚˜ ìˆ˜ì¹˜ë¥¼ ê·¼ê±°ë¡œ í•˜ë©°, ì›ì¸ë¶„ì„ê³¼ í–¥í›„ ì „ë§ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„œìˆ í•  ê²ƒ."
    elif report_type == "í–‰ì‚¬ë³´ê³ ":
        return "í–‰ì‚¬ë³´ê³ ëŠ” í–‰ì‚¬ ê°œìš”(ì¼ì‹œ, ì¥ì†Œ, ì°¸ê°€ì, ì£¼ìš”ë‚´ìš©), ì£¼ìš” ê²°ê³¼ ë° ì‹œì‚¬ì ì„ ì¤‘ì‹¬ìœ¼ë¡œ êµ¬ì„±í•  ê²ƒ."
    else:
        return "í–‰ì •ì—…ë¬´ìš© ì¼ë°˜ ë³´ê³ ì„œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•  ê²ƒ."

# âœ… ì„œì‹ë³„ ì§€ì‹œë¬¸
def get_prompt_by_format(report_format):
    if report_format == "ê°œìš” ì¤‘ì‹¬":
        return "ê°œìš”-ë³¸ë¡ -ê²°ë¡  êµ¬ì¡°ë¡œ ì‘ì„±í•  ê²ƒ. ì²« ë¬¸ë‹¨ì— ê°œìš”ë¥¼ ëª…í™•íˆ ì œì‹œí•˜ê³ , ì´í›„ ë¬¸ë‹¨ì—ì„œ ì„¸ë¶€ ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•  ê²ƒ."
    elif report_format == "í•­ëª© ë‚˜ì—´":
        return "ì£¼ìš” ë‚´ìš©ì„ ë²ˆí˜¸ ë˜ëŠ” ê¸°í˜¸(ì˜ˆ: â–¸, â) í˜•íƒœë¡œ ë‚˜ì—´í•˜ë©°, ê° í•­ëª©ì€ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ì„œìˆ í•  ê²ƒ."
    elif report_format == "í‘œ í˜•ì‹":
        return "í‘œ í˜•ì‹ ë‚´ìš©ì€ Markdown ê¸°ë°˜ í‘œ í˜•íƒœ(`| í•­ëª© | ë‚´ìš© |`)ë¡œ ì‘ì„±í•  ê²ƒ. í‘œëŠ” ì •ë ¬ì´ ìœ ì§€ë˜ë„ë¡ ì£¼ì˜í•˜ì—¬ ì‘ì„±í•  ê²ƒ."
    elif report_format == "ì„œìˆ í˜•":
        return "ì „ì²´ë¥¼ ë¬¸ë‹¨ ì¤‘ì‹¬ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ì„œìˆ í˜•ìœ¼ë¡œ ì‘ì„±í•  ê²ƒ. í•­ëª© êµ¬ë¶„ì€ í•˜ì§€ ì•Šì•„ë„ ë¨."
    else:
        return "ê¸°ë³¸ì ì¸ í–‰ì •ë¬¸ì„œ êµ¬ì„±ì— ë”°ë¼ ì‘ì„±í•  ê²ƒ."

# âœ… ê¸¸ì´ë³„ ì§€ì‹œë¬¸
def get_prompt_by_length(report_length):
    if report_length == "ê°„ëµ (1~2ë¬¸ë‹¨)":
        return "ì „ì²´ ë¶„ëŸ‰ì€ 1~2ë¬¸ë‹¨ ë‚´ì™¸ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•  ê²ƒ."
    elif report_length == "í‘œì¤€ (2~3ë¬¸ë‹¨)":
        return "ì „ì²´ ë¶„ëŸ‰ì€ 2~3ë¬¸ë‹¨ìœ¼ë¡œ êµ¬ì„±í•˜ë©°, ê° ë¬¸ë‹¨ì€ ëª…í™•í•œ ì£¼ì œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•  ê²ƒ."
    elif report_length == "ìƒì„¸ (3~4ë¬¸ë‹¨)":
        return "ì „ì²´ ë¶„ëŸ‰ì€ 3~4ë¬¸ë‹¨ ì´ìƒìœ¼ë¡œ ì‘ì„±í•˜ê³ , í•­ëª©ë³„ë¡œ ë…¼ë¦¬ì ì¸ êµ¬ì„±ì„ ë”°ë¥¼ ê²ƒ."
    else:
        return "ì ì ˆí•œ ë¶„ëŸ‰ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ë¬¸ë‹¨ë§ˆë‹¤ í•µì‹¬ ì£¼ì œë¥¼ ëª…í™•íˆ í•  ê²ƒ."

# âœ… í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
def build_user_prompt(title, report_type, report_format, report_length, key_points):
    type_instruction = get_prompt_by_report_type(report_type)
    format_instruction = get_prompt_by_format(report_format)
    length_instruction = get_prompt_by_length(report_length)

    # ğŸ¯ í–‰ì‚¬ë³´ê³ ì¼ ê²½ìš° íƒ€ì„í…Œì´ë¸” ì¶”ê°€ ì§€ì‹œ
    timetable_instruction = ""
    if report_type == "í–‰ì‚¬ë³´ê³ ":
        timetable_instruction = (
            "ë³´ê³ ì„œ ë§ë¯¸ì—ëŠ” '**í–‰ì‚¬ ì¼ì •í‘œ**'ë¼ëŠ” ì œëª©ê³¼ í•¨ê»˜ ë‹¤ìŒ ì˜ˆì‹œì²˜ëŸ¼ Markdown í‘œ í˜•íƒœë¡œ íƒ€ì„í…Œì´ë¸”ì„ ì‘ì„±í•  ê²ƒ:\n\n"
            "| ì‹œê°„    | í”„ë¡œê·¸ë¨ í•­ëª©             |\n"
            "|---------|---------------------------|\n"
            "| 10:00   | ê°œíšŒì‹                    |\n"
            "| 10:20   | ê¸ˆì—°ì•„íŒŒíŠ¸ ì§€ì •ì„œ ìˆ˜ì—¬ì‹ |\n"
            "| 10:40   | ì£¼ë¯¼ì°¸ì—¬ ìº í˜ì¸           |"
        )

    return f"""
ë„ˆëŠ” ì§€ë°©ìì¹˜ë‹¨ì²´ ê³µë¬´ì›ì„ ìœ„í•œ AI ë³´ê³ ì„œ ìƒì„±ê¸°ì•¼. ë°˜ë“œì‹œ ë‹¤ìŒ ì¡°ê±´ì— ë§ì¶° ì‘ì„±í•  ê²ƒ:

- ì „ì²´ ë¬¸ì²´ëŠ” 'í–‰ì •ë¬¸ì„œì²´'ë¡œ ì‘ì„±í•  ê²ƒ. ('~ë˜ì—ˆìŒ', '~ì„', '~í•„ìš”í•¨' ë“± ì‚¬ìš©)
- ì „ì²´ êµ¬ì„±ì€ ê°œê´„ì‹ì´ê³  ë¶ˆí•„ìš”í•œ ë¯¸ì‚¬ì—¬êµ¬ ì—†ì´ ê°„ê²°í•œ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•  ê²ƒ.

ğŸ“Œ ì œëª©: {title}  
ğŸ“„ ìœ í˜•: {report_type}  
ğŸ§© ì£¼ìš” í‚¤ì›Œë“œ: {key_points}

ì‘ì„± ì§€ì‹œ:
1. {type_instruction}
2. {format_instruction}
3. {length_instruction}
4. {timetable_instruction}

ë³´ê³ ì„œëŠ” ë‹¤ìŒ êµ¬ì¡°ë¥¼ ë”°ë¥¼ ê²ƒ:
1. ì œëª©
2. ê°œìš”
3. ì£¼ìš” ë‚´ìš© (í•„ìš” ì‹œ ë²ˆí˜¸, ê¸°í˜¸ ë˜ëŠ” í‘œ í¬í•¨)
4. í–¥í›„ ê³„íš ë˜ëŠ” ì‹œì‚¬ì 
"""

# âœ… Streamlit ì•±
def report_writer_app():
    st.title("ğŸ§  AI ê¸°ë°˜ ë³´ê³ ì„œ ìƒì„±ê¸°")

    report_type = st.selectbox("ğŸ“„ ë³´ê³ ì„œ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”", ["ê³„íšë³´ê³ ", "ë™í–¥ë³´ê³ ", "í–‰ì‚¬ë³´ê³ "])
    report_format = st.selectbox("ğŸ“ ë³´ê³ ì„œ ì„œì‹ì„ ì„ íƒí•˜ì„¸ìš”", ["ê°œìš” ì¤‘ì‹¬", "í•­ëª© ë‚˜ì—´", "í‘œ í˜•ì‹", "ì„œìˆ í˜•"])
    report_length = st.selectbox("ğŸ“ ë³´ê³ ì„œ ê¸¸ì´ë¥¼ ì„ íƒí•˜ì„¸ìš”", ["ê°„ëµ (1~2ë¬¸ë‹¨)", "í‘œì¤€ (2~3ë¬¸ë‹¨)", "ìƒì„¸ (3~4ë¬¸ë‹¨)"])
    title = st.text_input("ğŸ“Œ ë³´ê³ ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", placeholder="ì˜ˆ: ìŠ¤ë§ˆíŠ¸ì‹œí‹° ì¶”ì§„ê³„íš")
    key_points = st.text_area("ğŸ§© ì£¼ìš” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‰¼í‘œë¡œ êµ¬ë¶„)", placeholder="ì˜ˆ: ì§€ì—­ì—°ê³„, ì˜ˆì‚°í™•ë³´, íƒ€ë‹¹ì„± ê²€í† ")

    if st.button("ğŸ“„ ë³´ê³ ì„œ ìƒì„±"):
        if not title or not key_points:
            st.warning("ì œëª©ê³¼ ì£¼ìš” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            system_prompt = "ë„ˆëŠ” ì§€ë°©ìì¹˜ë‹¨ì²´ ê³µë¬´ì›ì„ ìœ„í•œ AI ë³´ê³ ì„œ ì‘ì„±ê¸°ì•¼."
            user_prompt = build_user_prompt(title, report_type, report_format, report_length, key_points)

            with st.spinner("ğŸ“¡ GPTê°€ ë³´ê³ ì„œë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤..."):
                response = client.chat.completions.create(
                    model="gpt-4o",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": user_prompt}
                    ],
                    temperature=0.5
                )

                content = response.choices[0].message.content.strip()
                st.success("âœ… ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!")
                st.markdown("### ğŸ“ ìƒì„±ëœ ë³´ê³ ì„œ")
                st.markdown(content.replace("\n", "\n\n"))

# âœ… ì‹¤í–‰
if __name__ == "__main__":
    report_writer_app()

